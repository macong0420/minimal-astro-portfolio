---
import { getCollection, render } from "astro:content";
import type { GetStaticPaths } from "astro";
import BaseLayout from "../../components/layout/BaseLayout.astro";
import Tags from "../../components/shared/Tags.astro";

export const getStaticPaths = (async () => {
  const posts = await getCollection("blog");
  const sortedPosts = posts.sort(
    (a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()
  );

  return sortedPosts.map((post, index) => ({
    params: { slug: post.id },
    props: {
      post,
      nextPost: index > 0 ? sortedPosts[index - 1] : null,
      prevPost: index < sortedPosts.length - 1 ? sortedPosts[index + 1] : null,
    },
  }));
}) satisfies GetStaticPaths;

const { post, prevPost, nextPost } = Astro.props;
const { Content } = await render(post);

const formatDate = (date: Date) => {
  return date.toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
};
---

<BaseLayout title={post.data.title} description={post.data.description}>
  <article class="post">
    <header>
      <h1>{post.data.title}</h1>
      <div class="metadata">
        <time datetime={post.data.publishedAt.toISOString()}>
          {formatDate(post.data.publishedAt)}
        </time>
        {post.data.tags && post.data.tags.length > 0 && (
          <Tags tags={post.data.tags} class="article-tags" />
        )}
      </div>
    </header>
    <div class="content">
      <Content />
    </div>
    <hr class="divider" />
    <nav class="post-nav">
      {
        prevPost ? (
          <a href={`/blog/${prevPost.id}`} class="nav-link prev">
            <span class="nav-label">← Previous</span>
            <span class="nav-title">{prevPost.data.title}</span>
          </a>
        ) : (
          <div />
        )
      }
      {
        nextPost && (
          <a href={`/blog/${nextPost.id}`} class="nav-link next">
            <span class="nav-label">Next →</span>
            <span class="nav-title">{nextPost.data.title}</span>
          </a>
        )
      }
    </nav>
  </article>
</BaseLayout>

<style>
  main {
    width: 100%;
    max-width: 640px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .post {
    margin-top: 2rem;
  }

  header {
    margin-bottom: 2rem;
  }

  h1 {
    margin-bottom: 0.5rem;
  }

  .metadata {
    display: flex;
    flex-direction: column;
    gap: 1rem;
    margin: 1rem 0 2rem;
  }

  time {
    color: var(--text-muted);
    font-size: var(--text-sm);
  }

  .article-tags {
    margin-top: 0.5rem;
  }

  .content {
    line-height: 1.7;
  }

  .content :global(h2) {
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .content :global(h3) {
    margin-top: 1.5rem;
    margin-bottom: 0.75rem;
  }

  .content :global(p) {
    margin-bottom: 1.25rem;
  }

  .content :global(img) {
    border-radius: 0.5rem;
    margin: 1.5rem 0;
  }

  .content :global(blockquote) {
    border-left: 3px solid var(--border-color);
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    color: var(--text-muted);
  }

  .content :global(pre) {
    padding: 1rem;
    border-radius: 0.5rem;
    background: var(--hover-bg);
    overflow-x: auto;
    margin: 1.5rem 0;
  }

  .content :global(p) {
    max-width: 100%;
  }

  .content :global(code) {
    font-family: var(--font-mono);
    font-size: var(--text-sm);
  }

  .content :global(a) {
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
  }

  .content :global(ul),
  .content :global(ol) {
    margin: 1rem 0;
    padding-left: 1.5rem;
  }

  .content :global(li) {
    margin: 0.5rem 0;
  }

  .divider {
    margin: 3rem 0;
    border: 0;
    border-top: 1px solid var(--border-color);
  }

  .post-nav {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 2rem;
    margin-top: 2rem;
  }

  .nav-link {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    text-decoration: none;
    color: var(--text-primary);
    padding: 1rem;
    border: 1px solid var(--border-color);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .nav-link:hover {
    border-color: var(--primary-color);
    background: var(--hover-bg);
  }

  .nav-link.next {
    text-align: right;
    align-items: flex-end;
  }

  .nav-label {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .nav-title {
    font-weight: 500;
    line-height: 1.4;
  }

  @media (max-width: 640px) {
    main {
      padding: 1rem;
    }

    .post-nav {
      grid-template-columns: 1fr;
      gap: 1rem;
    }

    .nav-link.next {
      text-align: left;
      align-items: flex-start;
    }
  }
</style>
